// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ข้อมูลจังหวัด
model Province {
  provinceId     Int    @id
  provinceNameEn String @unique
}

// ข้อมูลพืช
model Plant {
  plantId     String @id
  plantNameEn String
}

// ข้อมูลศัตรูพืช
model Pest {
  pestId     String @id
  pestNameEn String
}

// สถานะการตรวจสอบรายงาน
enum ReportStatus {
  PENDING // รอการตรวจสอบ
  VERIFIED // ผ่านการตรวจสอบแล้ว
  REJECTED // ถูกปฏิเสธ
}

// บทบาทผู้ใช้งาน
enum UserRole {
  ADMIN // ผู้ดูแลระบบ
  EXPERT // ผู้เชี่ยวชาญ
  USER // ผู้ใช้ทั่วไป
}

// โปรไฟล์ผู้ใช้ (เชื่อมกับ Supabase Auth)
model UserProfile {
  id            String         @id // Supabase auth.users UUID
  email         String         @unique
  role          UserRole       @default(USER)
  fullName      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  pestReports   PestReport[]
  notifications Notification[]
}

// ตารางหลักสำหรับเก็บรายงานการพบศัตรูพืช
model PestReport {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ข้อมูลพื้นที่และพืช
  province String
  plantId  String // ID อ้างอิงประเภทพืช

  // ข้อมูลศัตรูพืช
  pestId String // ID อ้างอิงศัตรูพืช

  // ข้อมูลเวลา
  reportedAt   DateTime @default(now())
  symptomOnSet DateTime // วันที่เริ่มพบอาการ

  // ข้อมูลเชิงปริมาณ (ใช้ Float เพื่อความแม่นยำในการคำนวณ)
  filedAffectedArea Float // พื้นที่ที่ได้รับผลกระทบ (ไร่)
  incidencePercent  Float // เปอร์เซ็นต์การระบาด (0-100)
  severityPercent   Float // เปอร์เซ็นต์ความรุนแรง (0-100)

  // ข้อมูลพิกัด (Geospatial)
  latitude  Float
  longitude Float

  // ข้อมูลรูปภาพ (รองรับไม่เกิน 2 รูปตาม UI)
  imageUrls     String[] // เก็บ URL จาก Cloud Storage
  imageCaptions String[] // เก็บ Caption ที่ผู้ใช้เขียน

  // ข้อมูลผู้รายงาน (Anonymous Support + Registered Attribution)
  isAnonymous       Boolean @default(false)
  reporterFirstName String? // ชื่อ (สำหรับ Anonymous หรือเลือกแสดงชื่อ)
  reporterLastName  String? // นามสกุล
  reporterPhone     String? // เบอร์ติดต่อ
  reporterRoles     String? // บทบาท

  // Registered User Link
  reporterUserId String? // Link to UserProfile if registered
  reporterUser   UserProfile? @relation(fields: [reporterUserId], references: [id])

  // Anonymous Tracking
  reporterEmail String? // Optional email for notifications
  ipHash        String? // Anti-spam
  sessionId     String? // Anti-spam

  // Verification Status (สถานะการตรวจสอบ)
  status          ReportStatus @default(PENDING)
  verifiedAt      DateTime? // วันที่ตรวจสอบ
  verifiedBy      String? // ชื่อผู้ตรวจสอบ
  rejectionReason String? // เหตุผลที่ปฏิเสธ

  // Relations
  notifications Notification[]

  // การทำ Index เพื่อให้ค้นหาข้อมูลตามจังหวัดหรือศัตรูพืชได้เร็วขึ้น
  @@index([province])
  @@index([pestId])
  @@index([status])
  @@index([reporterUserId])
}

// ระบบแจ้งเตือน
model Notification {
  id        String      @id @default(cuid())
  userId    String
  user      UserProfile @relation(fields: [userId], references: [id])
  type      String // "NEW_REPORT", "VERIFIED", "REJECTED"
  message   String
  reportId  String?
  report    PestReport? @relation(fields: [reportId], references: [id])
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([isRead])
}
