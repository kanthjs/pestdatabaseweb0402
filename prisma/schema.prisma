// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ข้อมูลจังหวัด
model Province {
  provinceId     Int          @id
  provinceCode   String       @unique // รหัสจังหวัด ISO 3166-2:TH
  provinceNameEn String       @unique
  provinceNameTh String?
  pestReports    PestReport[]
}

// ข้อมูลพืช
model Plant {
  plantId     String       @id
  plantNameEn String
  plantNameTh String?
  imageUrl    String?
  pestReports PestReport[]
}

// ข้อมูลศัตรูพืช
model Pest {
  pestId      String       @id
  pestNameEn  String
  pestNameTh  String?
  imageUrl    String?
  pestReports PestReport[]
}

// ข้อมูลระยะเดินเติบโตของพืช
model PlantGrowthStage {
  stageId     String  @id
  stageNameEn String
  stageNameTh String
}

// สถานะการขอเป็นผู้เชี่ยวชาญ
enum ExpertStatus {
  NONE // ไม่ได้ขอ
  PENDING // รอการตรวจสอบ
  APPROVED // ได้รับอนุมัติแล้ว
  REJECTED // ถูกปฏิเสธ
}

// สถานะการตรวจสอบรายงาน
enum ReportStatus {
  PENDING // รอการตรวจสอบ
  APPROVED // ผ่านการตรวจสอบแล้ว
  REJECTED // ถูกปฏิเสธ
}

// บทบาทผู้ใช้งาน
enum UserRole {
  ADMIN // ผู้ดูแลระบบ
  EXPERT // ผู้เชี่ยวชาญ
  USER // ผู้ใช้ทั่วไป
}

// โปรไฟล์ผู้ใช้ (เชื่อมกับ Supabase Auth)
model UserProfile {
  id              String         @id // Supabase auth.users UUID
  userName        String         @unique
  email           String         @unique
  role            UserRole       @default(USER)
  firstName       String?
  lastName        String?
  phone           String?
  occupationRoles String?
  expertRequest   ExpertStatus   @default(NONE)
  expertProofUrl  String? // รูปถ่ายบัตรเจ้าหน้าที่/หลักฐาน
  address         String?
  province        String?
  district        String?
  subDistrict     String?
  zipCode         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  pestReports     PestReport[]
  notifications   Notification[]
  activityLogs    ActivityLog[]
}

// ตารางหลักสำหรับเก็บรายงานการพบศัตรูพืช
model PestReport {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ข้อมูลพื้นที่และพืช
  provinceCode String
  province     Province @relation(fields: [provinceCode], references: [provinceCode])
  plantId      String // ID อ้างอิงประเภทพืช
  plant        Plant    @relation(fields: [plantId], references: [plantId])

  // ข้อมูลศัตรูพืช
  pestId String // ID อ้างอิงศัตรูพืช
  pest   Pest   @relation(fields: [pestId], references: [pestId])

  // ข้อมูลเวลา
  reportedAt   DateTime @default(now())
  symptomOnSet DateTime // วันที่เริ่มพบอาการ

  // ข้อมูลเชิงปริมาณ (ใช้ Float เพื่อความแม่นยำในการคำนวณ)
  fieldAffectedArea Float // พื้นที่ที่ได้รับผลกระทบ (ไร่)
  plantStage        String  @default("") // ระยะการเจริญเติบโตของพืช
  incidencePercent  Float // เปอร์เซ็นต์การระบาด (0-100)
  severityPercent   Float // เปอร์เซ็นต์ความรุนแรง (0-100)
  notes             String? // หมายเหตุ

  // ข้อมูลพิกัด (Geospatial)
  latitude  Float
  longitude Float

  // ข้อมูลรูปภาพ (รองรับไม่เกิน 2 รูปตาม UI)
  imageUrls     String[] // เก็บ URL จาก Cloud Storage
  imageCaptions String[] // เก็บ Caption ที่ผู้ใช้เขียน

  // ข้อมูลผู้รายงาน (Anonymous Support + Registered Attribution)
  isAnonymous       Boolean @default(false)
  reporterFirstName String? // ชื่อ (สำหรับ Anonymous หรือเลือกแสดงชื่อ)
  reporterLastName  String? // นามสกุล
  reporterPhone     String? // เบอร์ติดต่อ
  occupationRoles   String? // บทบาท

  // Registered User Link
  reporterUserId String? // Link to UserProfile if registered
  reporterUser   UserProfile? @relation(fields: [reporterUserId], references: [id])

  // Anonymous Tracking
  reporterEmail String? // Optional email for notifications
  ipHash        String? // Anti-spam
  sessionId     String? // Anti-spam

  // Verification Status (สถานะการตรวจสอบ)
  status          ReportStatus @default(PENDING)
  verifiedAt      DateTime? // วันที่ตรวจสอบ
  verifiedBy      String? // ชื่อผู้ตรวจสอบ
  rejectionReason String? // เหตุผลที่ปฏิเสธ
  deletedAt       DateTime? // Soft Delete

  // Relations
  notifications Notification[]

  // การทำ Index เพื่อให้ค้นหาข้อมูลตามจังหวัดหรือศัตรูพืชได้เร็วขึ้น
  @@index([provinceCode])
  @@index([pestId])
  @@index([plantId])
  @@index([status])
  @@index([reporterUserId])
}

// ระบบแจ้งเตือน
model Notification {
  id        String      @id @default(cuid())
  userId    String
  user      UserProfile @relation(fields: [userId], references: [id])
  type      String // "NEW_REPORT", "VERIFIED", "REJECTED"
  message   String
  reportId  String?
  report    PestReport? @relation(fields: [reportId], references: [id])
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([isRead])
}

// บันทึกกิจกรรมของผู้ดูแลระบบ (Audit Logs)
model ActivityLog {
  id         String      @id @default(cuid())
  adminId    String
  admin      UserProfile @relation(fields: [adminId], references: [id])
  action     String // e.g., "APPROVE_REPORT", "CHANGE_ROLE"
  entityId   String? // ID of the affected object (Report ID, User ID)
  entityType String? // "REPORT", "USER", "EXPERT_REQUEST"
  details    Json? // Additional details (reason, old/new values)
  createdAt  DateTime    @default(now())

  @@index([adminId])
  @@index([createdAt])
  @@index([entityId])
}
